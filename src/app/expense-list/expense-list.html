<mat-card class="expense-card">
    <div class="summary">
        <mat-card class="summary-card">
            <p>Total</p>
            <h3>₹ {{ totalAmount() }}</h3>
        </mat-card>

        <mat-card class="summary-card">
            <p>Paid</p>
            <h3>₹ {{ paidAmount() }}</h3>
        </mat-card>

        <mat-card class="summary-card">
            <p>Due</p>
            <h3>₹ {{ dueAmount() }}</h3>
        </mat-card>
    </div>

    <mat-card-title class="expense-list-title">
        Expense Details
        <button mat-icon-button color="primary" (click)="openFilterDialog()">
            <mat-icon>filter_list</mat-icon>
        </button>
        <button *ngIf="auth.isAdmin()" mat-icon-button color="primary" (click)="exportExcel()">
            <mat-icon>table_view</mat-icon>
        </button>

        <button *ngIf="auth.isAdmin()" mat-icon-button color="accent" (click)="exportPDF()">
            <mat-icon>picture_as_pdf</mat-icon>
        </button>
    </mat-card-title>

    <div class="sort-bar" *ngIf="isRangeFilterActive()">
        <mat-form-field appearance="outline">
            <mat-label>Sort By</mat-label>
            <mat-select [(value)]="sortBy">
                <mat-option value="date_desc">Date: Newest</mat-option>
                <mat-option value="date_asc">Date: Oldest</mat-option>
                <mat-option value="paid_first">Status: Paid First</mat-option>
                <mat-option value="due_first">Status: Due First</mat-option>
            </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="group-by">
            <mat-label>Group By</mat-label>
            <mat-select [(value)]="groupBy">
                <mat-option value="">None</mat-option>
                <mat-option value="date">Date</mat-option>
                <mat-option value="item">Item</mat-option>
                <mat-option value="status">Status</mat-option>
            </mat-select>
        </mat-form-field>
    </div>

    <!-- <mat-form-field appearance="outline" class="group-by">
        <mat-label>Group By</mat-label>
        <mat-select [(value)]="groupBy">
            <mat-option value="">None</mat-option>
            <mat-option value="date">Date</mat-option>
            <mat-option value="item">Item</mat-option>
            <mat-option value="status">Status</mat-option>
        </mat-select>
    </mat-form-field> -->

    <mat-accordion style="margin:5px;" *ngIf="groupBy()">
        <mat-expansion-panel *ngFor="let g of groupedExpenses()">
            <mat-expansion-panel-header>
                <mat-panel-title>
                    {{ g.key }}
                </mat-panel-title>
                <mat-panel-description>
                    ₹ {{ g.total }}
                </mat-panel-description>
            </mat-expansion-panel-header>

            <table class="expense-list-table" mat-table [dataSource]="g.items" class="mat-elevation-z8">

                <!-- Item -->
                <ng-container matColumnDef="item">
                    <th mat-header-cell *matHeaderCellDef> Item </th>
                    <td mat-cell *matCellDef="let e"> {{ e.item }} </td>
                </ng-container>

                <!-- Amount -->
                <ng-container matColumnDef="amount">
                    <th mat-header-cell *matHeaderCellDef> Rate </th>
                    <td mat-cell *matCellDef="let e"> ₹{{ e.amount }} </td>
                </ng-container>

                <!-- Date -->
                <ng-container matColumnDef="purchaseDate">
                    <th mat-header-cell *matHeaderCellDef> Date </th>
                    <td mat-cell *matCellDef="let e"> {{ e.purchaseDate | date:'dd MMM' }} </td>
                </ng-container>

                <!-- Status -->
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let e">
                        <mat-chip class="status-chip" [color]="e.status === 'Paid' ? 'primary' : 'warn'" selected
                            (click)="toggleStatus(e)">
                            {{ e.status }}
                        </mat-chip>
                    </td>
                </ng-container>

                <!-- Actions -->
                <ng-container *ngIf="auth.isAdmin()" matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef> Actions </th>
                    <td mat-cell *matCellDef="let e">
                        <button mat-icon-button color="primary" (click)="openEditDialog(e)">
                            <mat-icon>edit</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" (click)="deleteExpense(e)">
                            <mat-icon>delete</mat-icon>
                        </button>
                    </td>
                </ng-container>


                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
            </table>
        </mat-expansion-panel>
    </mat-accordion>


    <table *ngIf="!groupBy()" class="expense-list-table" mat-table [dataSource]="paginatedExpenses()"
        class="mat-elevation-z8">

        <!-- Item -->
        <ng-container matColumnDef="item">
            <th mat-header-cell *matHeaderCellDef> Item </th>
            <td mat-cell *matCellDef="let e"> {{ e.item }} </td>
        </ng-container>

        <!-- Amount -->
        <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef> Rate </th>
            <td mat-cell *matCellDef="let e"> ₹{{ e.amount }} </td>
        </ng-container>

        <!-- Date -->
        <ng-container matColumnDef="purchaseDate">
            <th mat-header-cell *matHeaderCellDef> Date </th>
            <td mat-cell *matCellDef="let e"> {{ e.purchaseDate | date:'dd MMM' }} </td>
        </ng-container>

        <!-- Status -->
        <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef>Status</th>
            <td mat-cell *matCellDef="let e">
                <mat-chip class="status-chip" [color]="e.status === 'Paid' ? 'primary' : 'warn'" selected
                    (click)="toggleStatus(e)">
                    {{ e.status }}
                </mat-chip>
            </td>
        </ng-container>

        <!-- Actions -->
        <ng-container *ngIf="auth.isAdmin()" matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef> Actions </th>
            <td mat-cell *matCellDef="let e">
                <button mat-icon-button color="primary" (click)="openEditDialog(e)">
                    <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="deleteExpense(e)">
                    <mat-icon>delete</mat-icon>
                </button>
            </td>
        </ng-container>


        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>

    <div class="empty" *ngIf="!filteredExpenses().length">
        No expenses available.
    </div>

    <mat-divider />

    <mat-paginator *ngIf="!groupBy()" [length]="filteredExpenses().length" [pageSize]="pageSize()"
        [pageSizeOptions]="pageSizeOptions" (page)="onPageChange($event)">
    </mat-paginator>


</mat-card>